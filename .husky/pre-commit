#!/usr/bin/env sh

# Check if there are newer commits on remote without pulling
git fetch --quiet || exit 1
if [ -n "$(git rev-list HEAD..@{u} 2>/dev/null)" ]; then
  echo "⚠️  Your branch is behind remote. Please run 'git pull' first."
  exit 1
fi

# Lint and format staged files, then re-stage them
npx lint-staged || exit 1

# Ensure tests/typecheck run against the STAGED snapshot, not local unstaged changes
# Stash unstaged changes (including untracked) while keeping the index intact
git stash -q --keep-index --include-untracked

# Always attempt to restore the stash on exit
restore_stash() {
  # Pop only if there is a stash entry and pop succeeds
  git stash pop -q 2>/dev/null || true
}
trap restore_stash EXIT

# Type check (runs on entire codebase) against staged snapshot
npm run typecheck || exit 1

# Tests with coverage threshold enforcement against staged snapshot
npm test --silent -- --bail --coverage || exit 1
